name: Trigger Azure DevOps Build

on:
  workflow_dispatch:
    inputs:
      orgName:
        description: 'Azure DevOps Organization Name'
        required: true
      projectName:
        description: 'Azure DevOps Project Name'
        required: true
      azurePipelineName:
        description: 'Azure DevOps Pipeline Name'
        required: true
        default: 'test_automation_repo'  # Default pipeline name if not provided
      resourceYamlFile:
        description: 'Resource YAML file (e.g., vm_provision.yaml)'
        required: true
        default: 'vm_provision.yaml'  # Default YAML file
        type: choice
        options:
          - 'vm_provision.yaml'
          - 'webapp_provision.yaml'
      targetRepositoryName:
        description: 'Target Repository Name'
        required: true
      pipelineName:
        description: 'Pipeline Name'
        required: true

env:
  RESOURCE_YAML: 'vm_provision.yaml'  # Default to vm_provision.yaml file
  SECRET_KEY: ${{ secrets.MY_SECRET_KEY }}  # Add the secret key from GitHub Secrets

jobs:
  trigger-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Trigger Azure DevOps Build
        run: |
          echo "Triggering Azure DevOps build with pipeline name ${{ github.event.inputs.azurePipelineName }} using YAML file ${{ github.event.inputs.resourceYamlFile }}..."
          
          # Perform the request to trigger the build with the provided parameters
          response=$(curl -L -s -w "%{http_code}" -o response.json -D headers.txt \
            -H "Authorization: Basic ${{ secrets.AZURE_DEVOPS_TOKEN }}" \  # Corrected header usage
            -H "Content-Type: application/json" \
            -d '{
                  "definition": {
                    "name": "${{ github.event.inputs.azurePipelineName }}"  # Using pipeline name instead of ID
                  },
                  "sourceBranch": "refs/heads/main",  # Adjust if you need a different branch
                  "parameters": {
                    "resourceYamlFile": "${{ github.event.inputs.resourceYamlFile }}",  # YAML file parameter
                    "orgName": "${{ github.event.inputs.orgName }}",  # Org name parameter
                    "projectName": "${{ github.event.inputs.projectName }}",  # Project name parameter
                    "targetRepositoryName": "${{ github.event.inputs.targetRepositoryName }}",  # Repository name parameter
                    "pipelineName": "${{ github.event.inputs.pipelineName }}",  # Pipeline name parameter
                    "secretKey": "${{ secrets.MY_SECRET_KEY }}"  # Pass the secret key securely
                  }
                }' \
            "https://dev.azure.com/${{ github.event.inputs.orgName }}/${{ github.event.inputs.projectName }}/_apis/build/builds?api-version=6.0")

          # Log response code, body, and headers for debugging
          echo "Response Status Code: $response"
          echo "Response Body: "
          cat response.json
          echo "Response Headers: "
          cat headers.txt

      - name: Check if the build was triggered successfully
        if: ${{ failure() }}
        run: |
          echo "Build trigger failed! Please check the response above for details."
          exit 1
