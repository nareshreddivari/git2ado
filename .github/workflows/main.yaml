name: Trigger Azure DevOps Build

on:
  workflow_dispatch:
    inputs:
      orgName:
        description: 'Azure DevOps Organization Name'
        required: true
        default: 'devopsokn'  # Replace with your Azure DevOps organization name
      projectName:
        description: 'Azure DevOps Project Name'
        required: true
        default: 'MyPOC'  # Replace with your Azure DevOps project name
      azurePipelineDefinitionId:
        description: 'Azure DevOps Pipeline Definition ID'
        required: true
        default: '260'  # Replace with your pipeline definition ID
      ResourceYamlFile:
        description: 'Select the resource YAML file'
        required: true
        type: choice
        options:
          - 'vm_provision.yaml'  # Replace with your YAML file options
          - 'webapp_provision.yaml'
      targetRepositoryName:
        description: 'Name of the repository'
        required: true
        default: 'test_App_Repo'  # Replace with your repository name
      pipelineName:
        description: 'Name of the pipeline'
        required: true
        default: 'pipeline'  # Replace with your pipeline name

env:
  RESOURCE_YAML: vm_provision.yaml  # Default to 'vm_provision.yaml' unless overridden

jobs:
  trigger-build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository to access the resources
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Print Authorization Token (for debugging)
      - name: Print Authorization Token
        run: |
          echo "Authorization Header: $(echo -n ":${{ secrets.AZURE_DEVOPS_TOKEN }}" | base64)"

      # Step 3: Print cURL Request Payload (for debugging)
      - name: Print cURL Request Payload
        run: |
          echo "cURL Request Payload: "
          echo '{
            "definition": {
              "id": "${{ github.event.inputs.azurePipelineDefinitionId }}"
            },
            "sourceBranch": "refs/heads/main",
            "parameters": {
              "yamlFile": "${{ env.RESOURCE_YAML }}",
              "orgName": "${{ github.event.inputs.orgName }}",
              "projectName": "${{ github.event.inputs.projectName }}",
              "targetRepositoryName": "${{ github.event.inputs.targetRepositoryName }}",
              "pipelineName": "${{ github.event.inputs.pipelineName }}"
            }
          }'

      # Step 4: Trigger Azure DevOps Build using cURL
      - name: Trigger Azure DevOps Build
        run: |
          echo "Triggering Azure DevOps build with definition ID ${{ github.event.inputs.azurePipelineDefinitionId }} using YAML file ${{ env.RESOURCE_YAML }}..."
          
          curl --http1.1 -v \
            -H "Authorization: Basic $(echo -n ":${{ secrets.AZURE_DEVOPS_TOKEN }}" | base64)" \
            -H "Content-Type: application/json" \
            -d '{
                  "definition": {
                    "id": "${{ github.event.inputs.azurePipelineDefinitionId }}"
                  },
                  "sourceBranch": "refs/heads/main",
                  "parameters": {
                    "yamlFile": "${{ env.RESOURCE_YAML }}",
                    "orgName": "${{ github.event.inputs.orgName }}",
                    "projectName": "${{ github.event.inputs.projectName }}",
                    "targetRepositoryName": "${{ github.event.inputs.targetRepositoryName }}",
                    "pipelineName": "${{ github.event.inputs.pipelineName }}"
                  }
                }' \
            "https://dev.azure.com/${{ github.event.inputs.orgName }}/${{ github.event.inputs.projectName }}/_apis/build/builds?api-version=6.1-preview.6"

      # Step 5: Handle the result of the build trigger
      - name: Check if the build was triggered successfully
        if: ${{ failure() }}
        run: |
          echo "Build trigger failed!"
          exit 1

      # Step 6: Post-job cleanup or additional actions
      - name: Post job cleanup
        run: |
          echo "Cleaning up after the build trigger..."
          # You can add any post-processing steps here
